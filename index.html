<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Biblioteca de Pel√≠culas</title>
    <style>
        * {margin: 0; padding: 0; box-sizing: border-box;}
        body {
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #fff; min-height: 100vh; padding: 20px;
        }
        .container {max-width: 1400px; margin: 0 auto;}
        header {text-align: center; padding: 40px 0; margin-bottom: 40px; position: relative;}
        h1 {
            font-size: 3em; font-weight: 700;
            background: linear-gradient(45deg, #f093fb, #f5576c);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        .subtitle {color: #b8b8d1; font-size: 1.2em;}
        .admin-btn {
            position: absolute; top: 20px; right: 20px;
            background: linear-gradient(45deg, #4facfe, #00f2fe);
            color: white; border: none; padding: 12px 25px;
            border-radius: 10px; font-weight: 600; cursor: pointer;
            text-decoration: none; display: inline-block;
            transition: all 0.3s ease;
        }
        .admin-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(79, 172, 254, 0.5);
        }
        .stats {display: flex; justify-content: center; gap: 30px; margin-top: 20px; flex-wrap: wrap;}
        .stat-item {
            background: rgba(255, 255, 255, 0.05); padding: 15px 30px;
            border-radius: 15px; backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .stat-number {font-size: 2em; font-weight: bold; color: #f5576c;}
        .movies-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px; margin-bottom: 40px;
        }
        .movie-card {
            background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px);
            border-radius: 20px; overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease; cursor: pointer;
        }
        .movie-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 60px rgba(245, 87, 108, 0.3);
            border-color: rgba(245, 87, 108, 0.5);
        }
        .movie-poster {
            width: 100%; height: 350px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex; align-items: center; justify-content: center;
            font-size: 4em; position: relative; overflow: hidden;
        }
        .movie-poster::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
            animation: shine 3s infinite;
        }
        @keyframes shine {
            0%, 100% {transform: translateX(-100%);}
            50% {transform: translateX(100%);}
        }
        .movie-number {
            position: absolute; top: 15px; right: 15px;
            background: rgba(0, 0, 0, 0.7); padding: 8px 15px;
            border-radius: 20px; font-size: 0.3em; font-weight: bold;
        }
        .movie-info {padding: 20px;}
        .movie-title {
            font-size: 1.2em; font-weight: 600; margin-bottom: 10px;
            color: #fff; overflow: hidden; text-overflow: ellipsis;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
        }
        .movie-meta {color: #b8b8d1; margin-bottom: 15px; font-size: 0.85em;}
        .play-btn {
            width: 100%; padding: 12px;
            background: linear-gradient(45deg, #f093fb, #f5576c);
            border: none; border-radius: 10px; color: white;
            font-size: 1em; font-weight: 600; cursor: pointer;
            transition: all 0.3s ease; text-decoration: none;
            display: block; text-align: center;
        }
        .play-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(245, 87, 108, 0.5);
        }
        .empty-state {
            text-align: center; padding: 60px 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px; backdrop-filter: blur(10px);
        }
        .empty-state h2 {font-size: 2em; margin-bottom: 15px; color: #f5576c;}
        .empty-state p {color: #b8b8d1; font-size: 1.1em; margin-bottom: 25px;}
        .loading {
            text-align: center; padding: 40px;
            font-size: 1.2em; color: #b8b8d1;
        }
        @media (max-width: 768px) {
            h1 {font-size: 2em;}
            .movies-grid {grid-template-columns: 1fr;}
            .admin-btn {position: static; margin-top: 15px;}
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <a href="admin.html" class="admin-btn">‚öôÔ∏è Administrar</a>
            <h1>üé¨ Mi Biblioteca Personal</h1>
            <p class="subtitle">Tus pel√≠culas, siempre disponibles</p>
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-number" id="movieCount">0</div>
                    <div>Pel√≠culas</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="totalSize">0</div>
                    <div>GB Total</div>
                </div>
            </div>
        </header>

        <div id="loadingState" class="loading">
            ‚è≥ Cargando biblioteca...
        </div>

        <div id="emptyState" class="empty-state" style="display: none;">
            <h2>üì≠ Tu biblioteca est√° vac√≠a</h2>
            <p>Comienza agregando pel√≠culas desde el administrador</p>
            <a href="admin.html" class="play-btn" style="max-width: 300px; margin: 0 auto;">
                ‚ûï Agregar Primera Pel√≠cula
            </a>
        </div>

        <div class="movies-grid" id="moviesGrid"></div>
    </div>

    <script>
        let movies = [];

        // Cargar pel√≠culas desde storage
        async function loadMovies() {
            try {
                const result = await window.storage.list('movie:');
                movies = [];
                
                if (result && result.keys && result.keys.length > 0) {
                    for (const key of result.keys) {
                        const data = await window.storage.get(key);
                        if (data && data.value) {
                            movies.push(JSON.parse(data.value));
                        }
                    }
                    
                    // Ordenar por ID (m√°s recientes primero)
                    movies.sort((a, b) => b.id - a.id);
                    
                    displayMovies();
                } else {
                    showEmptyState();
                }
            } catch (error) {
                console.error('Error cargando pel√≠culas:', error);
                showEmptyState();
            }
        }

        // Mostrar pel√≠culas
        function displayMovies() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('emptyState').style.display = 'none';
            
            const grid = document.getElementById('moviesGrid');
            
            grid.innerHTML = movies.map((movie, index) => `
                <div class="movie-card" onclick="openMovie('${movie.driveId}')">
                    <div class="movie-poster">${movie.emoji}<div class="movie-number">#${index + 1}</div></div>
                    <div class="movie-info">
                        <div class="movie-title">${movie.title}</div>
                        <div class="movie-meta">üíæ ${movie.size}</div>
                        <a href="https://drive.google.com/file/d/${movie.driveId}/view" 
                           target="_blank" 
                           class="play-btn" 
                           onclick="event.stopPropagation()">‚ñ∂ Ver Pel√≠cula</a>
                    </div>
                </div>
            `).join('');

            updateStats();
        }

        // Mostrar estado vac√≠o
        function showEmptyState() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('emptyState').style.display = 'block';
            document.getElementById('movieCount').textContent = '0';
            document.getElementById('totalSize').textContent = '0';
        }

        // Actualizar estad√≠sticas
        function updateStats() {
            document.getElementById('movieCount').textContent = movies.length;
            
            // Calcular tama√±o total
            const totalGB = movies.reduce((acc, movie) => {
                if (!movie.sizeBytes) return acc;
                return acc + (movie.sizeBytes / (1024 * 1024 * 1024));
            }, 0);
            
            document.getElementById('totalSize').textContent = totalGB.toFixed(1);
        }

        // Abrir pel√≠cula
        function openMovie(driveId) {
            window.open(`https://drive.google.com/file/d/${driveId}/view`, '_blank');
        }

        // Escuchar cambios desde el admin
        window.addEventListener('storage', function(e) {
            if (e.key === 'moviesUpdated') {
                loadMovies();
            }
        });

        // Recargar si hay cambios (para cuando admin y biblioteca est√°n abiertos)
        setInterval(async () => {
            const result = await window.storage.list('movie:');
            if (result && result.keys && result.keys.length !== movies.length) {
                loadMovies();
            }
        }, 3000);

        // Cargar al iniciar
        loadMovies();
    </script>
</body>
</html>
